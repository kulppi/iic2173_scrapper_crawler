var mongojs = require('mongojs');
var db = mongojs('crawlerdb', ['crawlercollection']);
//var db = mongojs('grupo1:iic2173@arqui2.ing.puc.cl/crawlerdb', ['mycollection']);
var fs = require('node-fs'),
	url = require('url'),
	Crawler = require("simplecrawler").Crawler
	//de forma iterativa...
var minutes = 10, the_interval = minutes * 60 * 1000;
setInterval(function() {
	console.log("empezando denuevo");

	var myCrawlerRT = new Crawler("www.rottentomatoes.com")
	myCrawlerRT.initialPath = "/";
	myCrawlerRT.interval = 500;
	myCrawlerRT.maxConcurrency = 5;
	myCrawlerRT.timeout = 1500;
	myCrawlerRT.listenerTTL = 1500;
	myCrawlerRT.queue.defrost("queueRT.json");

	myCrawlerRT.on("fetchstart",function(queueItem){
			console.log("Starting request for:",queueItem.url);
			console.log("RT: ", myCrawlerRT.queue.length);
			if(myCrawlerRT.queue.length > 10000)
			{
				myCrawlerRT.queue.splice(5000, 1000);
			}
		})

	myCrawlerRT.on("fetchcomplete",function(queueItem, responseBuffer, response) {
		console.log("I just received %s (%d bytes)",queueItem.url,responseBuffer.length);
		console.log("It was a resource of type %s",response.headers['content-type']);
		if(queueItem.url.indexOf("/m/") != -1)
		{
			var URLquery = db.crawlercollection.find({url: queueItem.url});
			URLquery.count(function (err, count) { 
				if(count==0){
					db.crawlercollection.save({url:queueItem.url, html:responseBuffer, sitio:"Rotten Tomatoes"});
					//console.log(responseBuffer.toString());
				}
			});

		}
	});
	console.log("ok");
	timeOutMinutes = 9, the_setTimeout = timeOutMinutes * 60 * 1000;
	setTimeout((function() {
		console.log("guardando lista...");
		myCrawlerRT.queue.freeze("queueRT.json");
		myCrawlerRT.stop();
		console.log("borrando myCrawlerRT...");
		delete myCrawlerRT;
	}), the_setTimeout);
	myCrawlerRT.start();
	
}, the_interval);
	
	console.log("empezando del principio");

	var myCrawlerRT = new Crawler("www.rottentomatoes.com")
	myCrawlerRT.initialPath = "/";
	myCrawlerRT.interval = 500;
	myCrawlerRT.maxConcurrency = 5;
	myCrawlerRT.timeout = 1500;
	myCrawlerRT.listenerTTL = 1500;
	myCrawlerRT.queue.defrost("queueRT.json");

	myCrawlerRT.on("fetchstart",function(queueItem){
			console.log("Starting request for:",queueItem.url);
			console.log("RT: ", myCrawlerRT.queue.length);
			if(myCrawlerRT.queue.length > 10000)
			{
				myCrawlerRT.queue.splice(5000, 1000);
			}
		})

	myCrawlerRT.on("fetchcomplete",function(queueItem, responseBuffer, response) {
		console.log("I just received %s (%d bytes)",queueItem.url,responseBuffer.length);
		console.log("It was a resource of type %s",response.headers['content-type']);
		if(queueItem.url.indexOf("/m/") != -1)
		{
			var URLquery = db.crawlercollection.find({url: queueItem.url});
			URLquery.count(function (err, count) { 
				if(count==0){
					db.crawlercollection.save({url:queueItem.url, html:responseBuffer, sitio:"Rotten Tomatoes"});
					//console.log(responseBuffer.toString());
				}
			});

		}
	});
	console.log("ok");
	timeOutMinutes = 9, the_setTimeout = timeOutMinutes * 60 * 1000;
	setTimeout((function() {
		console.log("guardando lista...");
		myCrawlerRT.queue.freeze("queueRT.json");
		myCrawlerRT.stop();
		console.log("borrando myCrawlerRT...");
		delete myCrawlerRT;
	}), the_setTimeout);
	myCrawlerRT.start();

