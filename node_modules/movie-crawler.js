var minutes = 30, the_interval = minutes * 60 * 1000;
setInterval(function() {
	console.log("empezando denuevo");
	var mongojs = require('mongojs');
	//var db = mongojs('crawlerdb', ['crawlercollection']);
	var db = mongojs('grupo1:iic2173@arqui2.ing.puc.cl/crawlerdb', ['mycollection']);

	var fs = require('node-fs'),
		url = require('url'),
		Crawler = require("simplecrawler").Crawler

	var myCrawlerIMDB = new Crawler("www.imdb.com")
	myCrawlerIMDB.initialPath = "/search/title?title_type=feature,tv_movie,short";
	myCrawlerIMDB.interval = 500;
	myCrawlerIMDB.maxConcurrency = 5;
	myCrawlerIMDB.timeout = 1500;
	myCrawlerIMDB.listenerTTL = 1500;
	myCrawlerIMDB.queue.defrost("queueIMDB.json");



	myCrawlerIMDB.on("fetchstart",function(queueItem){
			console.log("Starting request for:",queueItem.url);
			console.log("IMDB: ", myCrawlerIMDB.queue.length);
			if(myCrawlerIMDB.queue.length > 10000)
			{
				myCrawlerIMDB.queue.splice(5000, 1000);
			}
		})

	myCrawlerIMDB.on("fetchcomplete",function(queueItem, responseBuffer, response) {
		console.log("I just received %s (%d bytes)",queueItem.url,responseBuffer.length);
		console.log("It was a resource of type %s",response.headers['content-type']);
		if(queueItem.url.indexOf("title/tt") != -1 && queueItem.url.indexOf("criticreviews") == -1 && queueItem.url.indexOf("showtimes") == -1)
		{
			var URLquery = db.crawlercollection.find({url: queueItem.url});
			URLquery.count(function (err, count) { 
				if(count==0){
					db.crawlercollection.save({url:queueItem.url, html:responseBuffer, sitio:"IMDB"});
					//console.log(responseBuffer.toString());
				}
			});
		}

		// Do something with the data in responseBuffer
	});
	//---------------------------------------------------------------------------
	var myCrawlerRT = new Crawler("www.rottentomatoes.com")
	myCrawlerRT.initialPath = "/";
	myCrawlerRT.interval = 500;
	myCrawlerRT.maxConcurrency = 5;
	myCrawlerRT.timeout = 1500;
	myCrawlerRT.listenerTTL = 1500;
	myCrawlerIMDB.queue.defrost("queueRT.json");



	myCrawlerRT.on("fetchstart",function(queueItem){
			console.log("Starting request for:",queueItem.url);
			console.log("RT: ", myCrawlerRT.queue.length);
			if(myCrawlerRT.queue.length > 10000)
			{
				myCrawlerRT.queue.splice(5000, 1000);
			}
		})

	myCrawlerRT.on("fetchcomplete",function(queueItem, responseBuffer, response) {
		console.log("I just received %s (%d bytes)",queueItem.url,responseBuffer.length);
		console.log("It was a resource of type %s",response.headers['content-type']);
		if(queueItem.url.indexOf("/m/") != -1)
		{
			var URLquery = db.crawlercollection.find({url: queueItem.url});
			URLquery.count(function (err, count) { 
				if(count==0){
					db.crawlercollection.save({url:queueItem.url, html:responseBuffer, sitio:"Rotten Tomatoes"});
					//console.log(responseBuffer.toString());
				}
			});

		}
	});

	myCrawlerIMDB.start();
	myCrawlerRT.start();
	setTimeout((function() {
		myCrawlerIMDB.queue.freeze("queueIMDB.json");
		myCrawlerRT.queue.freeze("queueRT.json");
		myCrawlerIMDB.stop();
		myCrawlerRT.stop();
		delete myCrawlerIMDB;
		delete myCrawlerRT;
	}), 1740000);
}, the_interval);

